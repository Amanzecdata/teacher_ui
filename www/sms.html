<div class="container">
    <div class="row sms-main-container">
        <div class="container sms-box">
            <div class="row">
                <div class="col-md-12 col-sm-12 col-lg-4 col-12 d-none d-lg-block contacts-box" id="contacts-box">
                    <div class="col-lg-12 col-sm-12 col-md-12 col-12 user-box">
                        <div class="row conversation-header">
                            <div class="col-md-8 col-9 ">
                                <p class="font-20">Messages</p>
                            </div>
                            <!-- <div class="col-md-4 col-3 d-table p-0 m-auto">
                                <div class=" d-table-cell text-right">
                                    <div class="dropdown">
                                        <button class="dropbtn">
                                            <span class="fa fa-ellipsis-h"></span>
                                        </button>
                                        <div class="dropdown-content">
                                            <a href="#">Edit</a>
                                            <a href="#">Contact Us</a>
                                            <a href="#">Settings</a>
                                        </div>
                                    </div>
                                </div>
                            </div> -->
                        </div>

                        <!--<img src="img/john.jpg" class="user-img" alt=""/>
                            <p>John Doe</p>-->
                    </div>
                    <div class="col-lg-12 col-sm-12 col-md-12 col-12 user-chats">

                        <!-- <div class="single-contact row" id="1" onclick="open_chat(this)">
                            <div class="col-md-3 col-4">
                                <img src="img/profile_user.jpg" class="contact-img" alt="" />
                            </div>
                            <div class="col-md-9 col-8 contact-message-box">
                                <p class="contact-name">Nick William</p>
                                <p class="contact-last-message">This is a sample text</p>
                            </div>
                        </div>

                        <div class="single-contact active row" id="2" onclick="open_chat(this)">
                            <div class="col-md-3 col-4">
                                <img src="img/1.jpg" class="contact-img" alt="" />
                            </div>
                            <div class="col-md-9 col-8 contact-message-box">
                                <p class="contact-name">Mike Rose</p>
                                <p class="contact-last-message">This is a sample text</p>
                            </div>
                        </div> -->

                    </div>
                    <!-- <div class="bottom-bar row d-none-856 ">
                        <button class="btn col-md-6 col-6">
                            <span class="fa fa-cog text-blue"></span> Settings
                        </button>
                        <button class="btn col-md-6 col-6">
                            <span class="fa fa-user-plus text-blue"></span> Add Contact
                        </button>
                    </div> -->
                    <div class="bottom-bar row d-block-856 ">
                        <button class="btn col-md-6 col-6">
                            <span class="fa fa-cog text-blue"></span>
                        </button>
                        <button class="btn col-md-6 col-6">
                            <span class="fa fa-user-plus text-blue"></span>
                        </button>
                    </div>
                    <!-- <div class="create-new-chat">
                        <button class="btn">
                            <i class="fa fa-comment"></i>
                        </button>
                    </div> -->
                </div>
                <div class="col-md-12 col-sm-12 col-lg-8 col-12 chat-box" id="chat-box">
                    <div class="contact-chat row">
                        <div class="chat-header container-fluid">
                            <div class="row p-1">
                                <div class="col-3 col-md-4 p-0 text-center back-icon-div">
                                    <a class="back-icon" id="back-icon" href="javascript:go_to_chats()">
                                        <i class="fa fa-angle-left d-lg-none font-30 "></i>
                                    </a>

                                    <!-- <img src="img/1.jpg" class="contact-img" alt="" /> -->
                                </div>
                                <div class="col-md-8 col-9 d-table p-0 m-auto ">
                                    <div class="d-table-cell font-20" id="user-name"></div>
                                    <!-- <div class=" d-table-cell text-right">
                                        <div class="dropdown">
                                            <button class="dropbtn">
                                                <span class="fa fa-ellipsis-h"></span>
                                            </button>
                                            <div class="dropdown-content">
                                                <a href="#">Profile</a>
                                                <a href="#">Report</a>
                                                <a href="#">Block</a>
                                                <a href="#">Delete Chat</a>
                                            </div>
                                        </div>
                                    </div> -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 col-12 col-lg-12 col12 message-box" id="message-box">

                            <!-- <div class="message sent col-md-9 col-11">
                                <p class="col-md-12 col-12">Sed ac cursus tortor, id dictum velit. Nullam laoreet eros eu lectus mollis tempor. Sed at
                                    luctus nunc, at ullamcorper diam.</p>
                                <span>2:30pm</span>
                            </div>
                            <div class="message received col-md-9 col-11">
                                <p class="col-md-12 col-12">Nullam laoreet eros eu lectus mollis tempor. Sed ac cursus tortor, id dictum velit. Nullam
                                    laoreet eros eu lectus mollis tempor. Sed at luctus nunc, at ullamcorper diam.</p>
                                <span>2:38pm</span>
                            </div> -->

                        </div>
                        <div class="chat-footer">
                            <form class="p-1 w-100" id="message-form" onsubmit="return false;">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Compose ..." id="message">
                                    <div class="input-group-append">
                                        <button class="btn btn-primary" type="button" onclick="send_message()">
                                            <span class="fa fa-paper-plane"></span>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="scroll-to-bottom" id="scroll-btn">
                            <button type="button" class="btn" onclick="scroll_to_bottom()">
                                <i class="fa fa-angle-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    $(document).ready(function () {
        get_user_list(function (users) {
            var html = "";
            for (var user of users) {
                /// XXX @santosh add to users list section
                console.log(user)

                html += `<div class="single-contact row" id="${user.id}" onclick="open_chat(this, '${user.phone}', '${user.name}')">
                            <div class="col-md-9 col-8 contact-message-box">
                                <p class="contact-name">${user.name}</p>
                                <p class="contact-last-message">${user.phone}</p>
                            </div>
                        </div>`
            }

            $(".user-chats").append(html);
        });
    });


    /*IF NOT SCROLLED SHOW SCROLL BUTTON*/
    var objDiv = document.getElementById("message-box");
    var scrollBtn = document.getElementById("scroll-btn");
    var maxScrollValue = 0;
    objDiv.onscroll = function (e) {
        if (objDiv.scrollTop !== (maxScrollValue)) {
            scrollBtn.style.display = "block";
        }
        else {
            scrollBtn.style.display = "none";
        }

    };

    /*SCROLL MESSAGE BOX TO BOTTOM*/
    function scroll_to_bottom() {
        var objDiv = document.getElementById("message-box");
        objDiv.scrollTop = objDiv.scrollHeight;
        scrollBtn.style.display = "none";
        if (maxScrollValue < objDiv.scrollTop)
            maxScrollValue = objDiv.scrollTop;
    }
    scroll_to_bottom();

    /*DISPLAYING MESSAGE ON SCREEN*/
    function send_message() {
        var msg = document.getElementById("message").value;
        var today = new Date();

        //save message to database here.

        if (msg.trim() != '') {
            var div = document.createElement("div");
            div.className = "message sent col-md-9 col-11";
            var p = document.createElement("p");
            p.className = "col-md-12 col-12";
            var message = document.createTextNode(msg);
            var t = today.getHours() + ":" + today.getMinutes();
            var time = document.createTextNode(t);
            var span = document.createElement("span");
            p.appendChild(message);
            span.appendChild(time);
            div.appendChild(p);
            div.appendChild(span);
            objDiv.appendChild(div);

            console.log(user_phone);
            debugger

            send_user_sms(user_phone, msg, function (response) {
                console.log(response);
            });

            document.getElementById("message").value = '';
            scroll_to_bottom();
        }




    }

    /*WHEN BACK ICON IS CLICKED*/
    function go_to_chats() {

        //removing any active class in chats
        var elements = document.querySelectorAll('.single-contact');
        for (var i = 0; i < elements.length; i++) {
            elements[i].classList.remove('active');
        }

        var chatBox = document.getElementById("chat-box");
        var contactsBox = document.getElementById("contacts-box");
        contactsBox.classList.remove("d-none");
        chatBox.style.display = "none";
        contactsBox.style.display = "block";
        console.log("clicked");
    }

    var user_phone = "";

    /*ON CLICKING USER CHAT*/
    function open_chat(chat, phonenum, user_name) {
        //using chat id extract messages here.

        $("#message-box").empty();
        $("#user-name").empty();
        $("#user-name").text(user_name);
        user_phone = phonenum;

        //removing any active class in chats
        var elements = document.querySelectorAll('.single-contact');
        for (var i = 0; i < elements.length; i++) {
            elements[i].classList.remove('active');
        }

        chat.classList.add("active");
        var chatBox = document.getElementById("chat-box");
        var contactsBox = document.getElementById("contacts-box");

        if (document.getElementById("chat-box").style.display === "none")
        //if true we are on mobile
        {
            contactsBox.style.display = "none";
            //get message and display here.
            chatBox.style.display = "block";
        }
        else
        //we are not on mobile
        {
            //get messages and display here.
        }

        var html = "";
        get_sms_to_number(phonenum, function (res) {

            console.log(res);
            var filtered_data = res.filter(item => (item.to == "+1" + phonenum && item.from == "+15102885469") || (item.to == "+15102885469" && item.from == "+1" + phonenum));
            console.log(filtered_data);

            filtered_data.sort(function (a, b) {
                // Turn your strings into dates, and then subtract them
                // to get a value that is either negative, positive, or zero.
                if (a.date_created < b.date_created) return -1;
                if (a.date_created > b.date_created) return 1;
                return 0;
            });

            for (var msg of filtered_data) {

                if (msg.to == "+1" + phonenum) {

                    html += `<div class="message sent col-md-9 col-11">
                                <p class="col-md-12 col-12">${msg.body}</p>
                                <span>${msg.date_created}</span>
                            </div>`

                } else {

                    html += `<div class="message received col-md-9 col-11">
                                <p class="col-md-12 col-12">${msg.body}</p>
                                <span>${msg.date_created}</span>
                            </div>`

                }
            }

            $("#message-box").append(html);

        });

    }

</script>