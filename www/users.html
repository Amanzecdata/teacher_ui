<!DOCTYPE html>
<html lang="en">
<head>
  <title>Teacher Portal</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
  rel="stylesheet"
  href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
  crossorigin="anonymous"
  />
  <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
  />
  <script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"
  ></script>
  <script
  src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
  integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
  crossorigin="anonymous"
  ></script>
  <script
  src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
  crossorigin="anonymous"
  ></script>
  
  <!-- user.html JS, CSS start -->
  <link
  rel="stylesheet"
  href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css"
  />
  <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script>
  <script
  async
  defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDWJ2UbLhFeu3jVgd4ZwWMMNyGl4Kqx7V4"
  ></script>
  <!-- user.html JS, CSS end -->
  
  <link rel="stylesheet" href="css/dashboard.css" />
  <!-- <link rel="stylesheet" href="css/bootstrap.css"> -->
  <link rel="stylesheet" href="css/sidebar.css" />
  <link rel="stylesheet" href="css/setting.css" />
  <link rel="stylesheet" href="css/sms.css" />
  <link rel="stylesheet" href="css/header.css" />
  <link rel="stylesheet" href="css/administration.css" />
  <link rel="stylesheet" href="css/spinner.css" />
  
  <script src="js/main.js"></script>
  <script src="js/web_api.js"></script>
  
  <style>
    .p-0 .container-fluid {
      padding-left: 0px !important;
      padding-right: 0px !important;
    }
    .video_entry, .gps-entry{
      background-color: #80808040;
    }
    .modal-content {
      width:100%;
    }
    
    .modal-dialog-centered {
      margin-top: 10%;
    }
    .chips-shadow {
      -moz-box-shadow:    inset 0 0 10px #000000;
      -webkit-box-shadow: inset 0 0 10px #000000;
      box-shadow:         inset 0 0 10px #000000;
    }
    
  </style>
  
  <script>
    function myFunction() {
      var x = document.getElementById("myLinks");
      if (x.style.display === "block") {
        x.style.display = "none";
      } else {
        x.style.display = "block";
      }
    }
  </script>
</head>

<body>
  <div class="container-fluid p-0">
    <!-- Bootstrap row -->
    <div class="row" id="body-row">
      <div id="left-sidebar"></div>
      <div class="col p-0 content-div">
        <div id="page-header"></div>
        <div class="container my-2" style="width: 100% !important;">
          <div id="userListData">
            <h2>
              <b>Users</b>
            </h2>
            <div class="table-div">
              <table
              id="userTable"
              class="table table-striped table-bordered"
              style="width: 100%"
              >
              <thead>
                <tr>
                  <th>Joined</th>
                  <th>Name</th>
                  <th>Phone</th>
                  <th>Info</th>
                  <th>Call Member</th>
                </tr>
              </thead>
              <tbody id="body-data"></tbody>
            </table>
            <div id="usersloader" class="d-flex justify-content-center">
              <svg style="height: auto; width: 120px;" version="1.1"
              xmlns="http://www.w3.org/2000/svg"
              xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="25 25 50 50">
              <circle cx="50" cy="50" r="20" fill="none" stroke-width="5" stroke="#132644" stroke-linecap="round" stroke-dashoffset="0" stroke-dasharray="100, 200">
                <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 50 50" to="360 50 50" dur="2.5s" repeatCount="indefinite"/>
                <animate attributeName="stroke-dashoffset" values="0;-30;-124" dur="1.25s" repeatCount="indefinite"/>
                <animate attributeName="stroke-dasharray" values="0,200;110,200;110,200" dur="1.25s" repeatCount="indefinite"/>
              </circle>
            </svg>
          </div>
        </div>
      </div>
      
      <div id="showUserInfo" style="display: none" class="pt-3">
        <!-- <form id="placeForm">
          
        </form> -->
        <div>
          <button onclick="goBack()" class="btn">
            <i class="fa fa-chevron-left"></i> Back
          </button>
        </div>
        <h2 class="text-center">
          <b>User Information</b>
        </h2>
        <form class="px-2">
          <div class="form-group">
            <label for="uname">
              <b>Name</b>
            </label>
            <input
            type="text"
            class="form-control"
            id="uname"
            placeholder="Name"
            readonly
            />
          </div>
          
          <div class="form-group">
            <label for="phone">
              <b>Phone</b>
            </label>
            <input
            type="text"
            class="form-control"
            id="phone"
            placeholder="Phone"
            readonly
            />
          </div>
          
          <div class="form-group">
            <label for="joined">
              <b>Joined</b>
            </label>
            <input
            type="text"
            class="form-control"
            id="joined"
            placeholder="Joined"
            readonly
            />
          </div>
          
          <div class="form-group">
            <label>
              <b>Questions/Answers</b>
            </label>
            <div id="answerList"></div>
          </div>
          
          <div class="form-group">
            <label>
              <b>Tags</b>
            </label>
            <div id="tags">
              <div id="tagslist" class="p-2 chips-shadow">
                <div id="tag_loader_wrapper" class="d-flex justify-content-center">
                  <svg id="tagLoader" style="height: auto; width: 40px;" version="1.1"
                  xmlns="http://www.w3.org/2000/svg"
                  xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="25 25 50 50">
                  <circle cx="50" cy="50" r="20" fill="none" stroke-width="5" stroke="#132644" stroke-linecap="round" stroke-dashoffset="0" stroke-dasharray="100, 200">
                    <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 50 50" to="360 50 50" dur="2.5s" repeatCount="indefinite"/>
                    <animate attributeName="stroke-dashoffset" values="0;-30;-124" dur="1.25s" repeatCount="indefinite"/>
                    <animate attributeName="stroke-dasharray" values="0,200;110,200;110,200" dur="1.25s" repeatCount="indefinite"/>
                  </circle>
                </svg>
              </div>
              </div>
              <textarea class="mt-2 p-3" name="tagInput" style="width: 100%;" id="tagTextArea" onkeypress="addTag(event)" placeholder="Your tag..."></textarea>
            </div>
          </div>
          
          <div class="form-group">
            <label>
              <b>Activities</b>
            </label>
            <!-- <div class="spinner-border"></div>
              <div class="d-flex justify-content-center">
                <div class="spinner-border" role="status">
                  <span class="sr-only">Loading...</span>
                </div>
              </div>               -->
              <div id="activityList">
                <div class="d-flex justify-content-center">
                  <svg style="height: auto; width: 120px;" version="1.1"
                  xmlns="http://www.w3.org/2000/svg"
                  xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="25 25 50 50">
                  <circle cx="50" cy="50" r="20" fill="none" stroke-width="5" stroke="#132644" stroke-linecap="round" stroke-dashoffset="0" stroke-dasharray="100, 200">
                    <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 50 50" to="360 50 50" dur="2.5s" repeatCount="indefinite"/>
                    <animate attributeName="stroke-dashoffset" values="0;-30;-124" dur="1.25s" repeatCount="indefinite"/>
                    <animate attributeName="stroke-dasharray" values="0,200;110,200;110,200" dur="1.25s" repeatCount="indefinite"/>
                  </circle>
                </svg>
              </div>
            </div>
          </div>
        </form>
      </div>
      
      <!-- Add Phone number Modal -->
      <div
      class="modal fade"
      id="phoneModal"
      tabindex="-1"
      role="dialog"
      aria-hidden="true"
      >
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              Enter your phone number and we will connect you
            </h5>
            <button
            type="button"
            class="close"
            data-dismiss="modal"
            aria-label="Close"
            >
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form class="px-2">
            <div class="form-group">
              <label for="phone">Phone</label>
              <input
              type="number"
              class="form-control"
              id="uname"
              placeholder="Phone"
              />
            </div>
            <button type="button" class="btn btn-primary float-right">
              Call
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
</div>
</div>
</div>
<div class="modal fade"
id="activityModal"
tabindex="-1"
role="dialog"
aria-labelledby="activityModalLabel"
aria-hidden="true"
>
<div
class="modal-dialog modal-dialog-centered"
role="document"
>
<div class="modal-content">
  <div class="modal-header">
    <button
    type="button"
    class="close"
    data-dismiss="modal"
    aria-label="Close"
    >
    <span aria-hidden="true">&times;</span>
  </button>
</div>
<div id="activity-body" class="modal-body text-center"></div>
</div>
</div>
</div>

<script>
  var user_phone = "";
  var passwordResetToken = getParam("token");
  var userToken = localStorage.getItem("user-token");
  
  console.log("MODE: PASSWORD_RESET, Token - " + passwordResetToken);
  
  if (userToken == null) {
    window.location.replace("student_login.html");
  }
  setup_activity_view_events();
  function getParam(sParam) {
    var sPageURL = window.location.search.substring(1);
    var sURLVariables = sPageURL.split("&");
    for (var i = 0; i < sURLVariables.length; i++) {
      var sParameterName = sURLVariables[i].split("=");
      if (sParameterName[0] == sParam) {
        return sParameterName[1];
      }
    }
  }
  
  $(document).ready(function () {
    $("#left-sidebar").load("sidebar.html");
    $("#page-header").load("header.html");
    //                        $("#page-container").load('dashboard.html');
  });
  $("#body-row .collapse").collapse("hide");
  
  // Collapse/Expand icon
  //$('#collapse-icon').addClass('fa-angle-double-left');
  
  // Collapse click
  function left_sidebar() {
    SidebarCollapse();
  }
  
  function SidebarCollapse() {
    $(".menu-collapsed").toggleClass("d-none");
    $(".sidebar-submenu").toggleClass("d-none");
    $(".submenu-icon").toggleClass("d-none");
    $("#sidebar-container").toggleClass(
    "sidebar-expanded sidebar-collapsed"
    );
    
    // Treating d-flex/d-none on separators with title
    var SeparatorTitle = $(".sidebar-separator-title");
    if (SeparatorTitle.hasClass("d-flex")) {
      SeparatorTitle.removeClass("d-flex");
    } else {
      SeparatorTitle.addClass("d-flex");
    }
    
    // Collapse/Expand icon
    //$('#collapse-icon').toggleClass('fa-angle-double-left fa-angle-double-right');
  }
  var user_list = [];
  var selected_user_index;
  $(document).ready(function () {
    get_user_list(function (users) {
      user_list = users;
      document.getElementById("usersloader").remove();
      users.forEach((item, i) => {
        $("#body-data").append(`<tr>
          <td>${item.created_at}</td>
          <td>${item.name}</td>
          <td>${item.phone}</td>
          <td><button onclick="info('${i}')" class="btn btn-primary btn-edit"><i class="fa fa-info-circle"></i></button></td>
          <td><button class="btn btn-primary btn-edit" data-toggle="modal" data-target="#phoneModal" type="button"><i class="fa fa-phone-square"></i></button></td>
        </tr>`);
      });
      
      $("#userTable").DataTable();
    });
  });
  
  function goBack() {
    $("#userListData").show();
    $("#showUserInfo").hide();
  }
  
  function info(ind) {
    selected_user_index = ind;
    user_phone = user_list[ind].phone;
    get_activity_list(user_list[ind].phone,function(activities){
      console.log(activities)
      $('#activityList').empty();
      html=`<div id="accordion">`;
        activities.user_activities.forEach((item, i) => {
          if (item.type == 'video') {
            var html =
            '<div class="border rounded mb-2"> <div class="video_entry p-3" video_url="' +
              item.video_url +
              '"><a href="javascript:void(0)" class="video-view"><span class="glyphicon glyphicon-facetime-video pr-2"></span></a> \
              <a href="javascript:void(0)" class="btn-link" data-toggle="collapse" data-target="#collapse'+i+'" aria-expanded="false" aria-controls="collapse'+i+'"><span class="glyphicon glyphicon glyphicon-envelope pr-2"></span></a><span>\
                ' +
                format_date(item.created_at) +
                '</span></div>'+
                `<div id="collapse${i}" class="collapse" aria-labelledby="heading${i}" data-parent="#accordion">
                  <div class="card-body">
                    <div class="comments">
                      <h5 class="font-weight-bold mb-1"> Feedbacks </h5>
                      `
                      item.feedbacks.forEach((feed,j)=>{
                        html += `<div id="" class="pl-3 ${i != 0?'mt-2':''}" data-feedId=${feed.feed_id}>
                          <h5 class="text-blue mb-0 font-weight-bold"> ${feed.uesr_details.first_name + ' ' +feed.uesr_details.last_name} </h5>
                          <p class="mt-1 mb-0"> ${feed.message}</p>
                          <h6 class="m-0 text-info" style="font-size:xx-small">${format_date(new Date(feed.created_at).getTime()/1000)}</h6>
                        </div>`
                      })
                      
                      html += `</div>
                      <h5 class="font-weight-bold"> Text Reply </h5>
                      <form class="form-inline">
                        <div class="form-group mb-2">
                          <label for="staticPhone${i}" class="sr-only">Phone number</label>
                          <input type="text" readonly class="form-control-plaintext" id="staticPhone${i}" value="${user_list[ind].phone}">
                        </div>
                        <div class="form-group mx-sm-3 mb-2">
                          <label for="inputMessage${i}" class="sr-only">Message</label>
                          <input type="text" class="form-control" id="inputMessage${i}" placeholder="Your message">
                        </div>
                        <button type="button" class="btn btn-primary mb-2" data-logId=${item.video_uuid} onclick="send_message(${i}, event, 'video')">Send</button>
                      </form>
                    </div>
                  </div>
                </div>`;
              } else if (item.type == 'gps') {
                var html =
                '<div class="border rounded mb-2"> <div class="gps-entry p-3" lat="' +
                  item.lat +
                  '" lng="' +
                  item.lng +
                  `"><a href='javascript:void(0)' class="gps-view"><span class='glyphicon glyphicon-map-marker pr-2'></span></a>` +
                  '<a href="javascript:void(0)" class="btn-link" data-toggle="collapse" data-target="#collapse'+i+'" aria-expanded="false" aria-controls="collapse'+i+'"><span class="glyphicon glyphicon glyphicon-envelope pr-2"></span></a><span>' +
                    format_date(item.created_at) +
                    '</span>&nbsp - &nbsp' +
                    '<span>' +
                      item.msg +
                      '</span></div>'+
                      `<div id="collapse${i}" class="collapse" aria-labelledby="heading${i}" data-parent="#accordion">
                        <div class="card-body">
                          <div class="comments">
                            <h5 class="font-weight-bold mb-1"> Feedbacks </h5>`
                            item.feedbacks.forEach((feed,j)=>{
                              html += `<div class="pl-3 ${i != 0?'mt-2':''}" data-feedId=${feed.feed_id}>
                                <h5 class="text-blue mb-0 font-weight-bold"> ${feed.uesr_details.first_name + ' ' +feed.uesr_details.last_name} </h5>
                                <p class="mt-1 mb-0"> ${feed.message}</p>
                                <h6 class="m-0 text-info" style="font-size:xx-small">${format_date(new Date(feed.created_at).getTime()/1000)}</h6>
                              </div>`
                            })
                            html += `</div><h5 class="font-weight-bold"> Text Reply </h5>
                            <form class="form-inline">
                              <div class="form-group mb-2">
                                <label for="staticPhone${i}" class="sr-only">Phone number</label>
                                <input type="text" readonly class="form-control-plaintext" id="staticPhone${i}" value="${user_list[ind].phone}">
                              </div>
                              <div class="form-group mx-sm-3 mb-2">
                                <label for="inputMessage${i}" class="sr-only">Message</label>
                                <input type="text" class="form-control" id="inputMessage${i}" placeholder="Your message">
                              </div>
                              <button type="button" class="btn btn-primary mb-2" data-logId=${item.id} onclick="send_message(${i}, event,'gps')">Send</button>
                            </form>
                          </div>
                        </div>
                      </div>`;
                    }
                    $('#activityList').append(html);
                  });
                  get_tags(user_list[ind].id, function(res){
                    $('#tagLoader').hide();
                    let loader = $('#tag_loader_wrapper');
                    $('#tagslist').empty();
                    $('#tagslist').append(loader);
                    console.log(res);
                    let html = ''
                    res.tags.forEach(tag=>{
                      html+=`<span class="badge badge-primary mr-2" data-toggle="tooltip" title="Assigned By:${tag.assignedBy.first_name}" data-tagId=${tag.id}>${tag.tag}</span>`;
                    });
                    $('#tagslist').append(html);
                  });
                });
    console.log(user_list[ind]);
    $("#userListData").hide();
    $("#showUserInfo").show();
    
    $("#uname").val(user_list[ind].name);
    $("#phone").val(user_list[ind].phone);
    $("#joined").val(user_list[ind].created_at);

    let loader = $('#tag_loader_wrapper');
    $('#tagslist').empty();
    $('#tagslist').append(loader);
    $("#answerList").empty();
    $('#tagLoader').show();
    var html = "";
    
    user_list[ind].answers.forEach((item, i) => {
      html += `<div class="form-group">
        <label>${i + 1}. ${item.question}</label>
        <input type="text" class="form-control" value="${
          item.answer
        }" readonly>
      </div>`;
    });
    
    $("#answerList").append(html);
  }
  function send_message(index, event, type) {
    var msg = document.getElementById("inputMessage"+index).value;
    if (msg.trim() != "") {              
      event.target.innerHTML = 'Sending';
      document.getElementById("inputMessage"+index).value = "";
      send_feedback(msg, type, event.target.dataset.logid, function (response,err) {
        if(!err){
          var feed = JSON.parse(response).feed;
          document.getElementById("inputMessage"+index).value = ""; 
          event.target.innerHTML = 'Send';
          var comment = document.createElement('div');
          comment.setAttribute('feedId', feed.feed_id);
          comment.innerHTML = `<div class="pl-3">
            <h5 class="text-blue mb-0 font-weight-bold"> ${feed.user_details.first_name + ' ' +feed.user_details.last_name} </h5>
            <p class="mt-1 mb-0"> ${msg}</p>
            <h6 class="m-0 text-info" style="font-size:xx-small">${format_date(new Date(feed.created_at).getTime()/1000)}</h6>
          </div>`;
          event.target.parentNode.parentNode.getElementsByClassName('comments')[0].append(comment);
        }
      });              
    }                      
  }
  
  function addTag(event){
    if(window.event.keyCode == 13){
      $('#tagLoader').hide();
      let tag = $('#tagTextArea').val().trim();
      $('#tagTextArea').val('');
      $('#tagTextArea').attr('disabled', true);
      if(tag){
        let html =`<span class="badge badge-primary temp-tag" data-toggle="tooltip" title="Assigned By:${window.curr_user?window.curr_user.name:'Anonymous'}">${tag}</span>`;
        $('#tagslist').append(html);
        assignTag(tag, user_list[selected_user_index].id, function(res,err){
          $('#tagslist').find('.temp-tag').each((i, ele)=>{ele.remove()});
          $('#tagTextArea').removeAttr('disabled');
          if(err){
            alert('ERROR');
          }else{
            let html =`<span class="badge badge-primary" data-toggle="tooltip" title="Assigned By:${res.assigned_by}" data-tagId=${res.tagId}>${tag}</span>`;
            $('#tagslist').append(html);
          }
        });
      }
    }
  }
  $(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();
  });
            </script>
          </body>
          </html>
          
