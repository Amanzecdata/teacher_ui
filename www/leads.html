<!DOCTYPE html>
<html lang="en">
     <head>
          <title>Teacher Portal</title>
          <meta charset="utf-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1" />

          <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
               integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"/>
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"/>
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.css" />

          <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/1.1.3/sweetalert.min.js"></script>
          <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
          <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
                    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
                    crossorigin="anonymous"></script>

          <!-- user.html JS, CSS start -->
          <link rel="stylesheet" href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css"/>
          <script src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
          <script src="https://cdn.datatables.net/1.10.22/js/dataTables.bootstrap4.min.js"></script>
          <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDWJ2UbLhFeu3jVgd4ZwWMMNyGl4Kqx7V4"></script>
          <!-- user.html JS, CSS end -->

          <link rel="stylesheet" href="css/dashboard.css" />
          <!-- <link rel="stylesheet" href="css/bootstrap.css"> -->
          <link rel="stylesheet" href="css/sidebar.css" />
          <link rel="stylesheet" href="css/setting.css" />
          <link rel="stylesheet" href="css/sms.css" />
          <link rel="stylesheet" href="css/header.css" />
          <link rel="stylesheet" href="css/administration.css" />
          <link rel="stylesheet" href="css/spinner.css" />

          <script src="js/main.js"></script>
          <script src="js/web_api.js"></script>

          <style>
               .p-0 .container-fluid {
                    padding-left: 0px !important;
                    padding-right: 0px !important;
               }
               .video_entry, .gps-entry{
                    background-color: #80808040;
               }
               .modal-content {
                    width:100%;
               }
               .modal-dialog-centered {
                    margin-top: 10%;
               }
               .chips-shadow {
                    -moz-box-shadow:    inset 0 0 10px #000000;
                    -webkit-box-shadow: inset 0 0 10px #000000;
                    box-shadow:         inset 0 0 10px #000000;
               }
               #userLeadData #add_lead{
                    position: absolute;
                    right: 16%;
               }
          </style>
          
          <script>
               function myFunction() {
                    var x = document.getElementById("myLinks");
                    if (x.style.display === "block") {
                    x.style.display = "none";
                    } else {
                    x.style.display = "block";
                    }
               }
          </script>
     </head>

     <body>
          <div class="container-fluid p-0">
               <!-- Bootstrap row -->
               <div class="row" id="body-row">
                    <div id="left_sidebar">
                    </div>
                    <div class="col p-0 content-div">
                         <div id="page_header">
                         </div>
                         <div class="container my-2" style="width: 100% !important;">
                              <div id="userLeadData">
                                   <div class="row">
                                        <h2>
                                             <b>Uaer leads</b>
                                        </h2>
                                        <button class="btn btn-info"  type="button" id="add_lead">
                                             ADD
                                        </button>
                                   </div>
                                   <div class="table-div">
                                        <table id="lead_table" class="table table-striped table-bordered" style="width: 100%">
                                             <thead>
                                                  <tr>
                                                       <th>Name</th>
                                                       <th>Phone</th>
                                                       <th>State</th>
                                                       <th>Status</th>
                                                       <th>Notes</th>
                                                       <th>Call Member</th>
                                                  </tr>
                                             </thead>
                                             <tbody id="lead_data">
                                             </tbody>
                                        </table>
                                        <div id="lead_loader" class="d-flex justify-content-center">
                                             <svg style="height: auto; width: 120px;" version="1.1"
                                                  xmlns="http://www.w3.org/2000/svg"
                                                  xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="25 25 50 50">
                                                  <circle cx="50" cy="50" r="20" fill="none" stroke-width="5" stroke="#132644" stroke-linecap="round" stroke-dashoffset="0" stroke-dasharray="100, 200">
                                                       <animateTransform attributeName="transform" attributeType="XML" type="rotate" from="0 50 50" to="360 50 50" dur="2.5s" repeatCount="indefinite"/>
                                                       <animate attributeName="stroke-dashoffset" values="0;-30;-124" dur="1.25s" repeatCount="indefinite"/>
                                                       <animate attributeName="stroke-dasharray" values="0,200;110,200;110,200" dur="1.25s" repeatCount="indefinite"/>
                                                  </circle>
                                             </svg>
                                        </div>
                                   </div>
                              </div>
                              
                              <!-- add new lead to db -->
                              <div id="addLead" style='display:none'>
                                   <div>
                                        <button onclick="goBack()" class="btn">
                                             <i class="fa fa-chevron-left"></i> Back
                                        </button>
                                   </div>
     
                                   <h2 class="text-center">
                                        <b id="addTitle">Add New Lead</b>
                                   </h2>
     
                                   <form class="pt-2 pt-3">
                                        <div class="form-group">
                                             <label for="name">Name</label>
                                             <input type="text" class="form-control" id="name" placeholder="Name" />
                                        </div>
                                        <div class="form-group">
                                             <label for="phone">Phone</label>
                                             <input type="phone" class="form-control" id="phone" placeholder="Phone" />
                                        </div>
                                        <div class="form-group">
                                             <label for="email">email</label>
                                             <input type="email" class="form-control" id="email" placeholder="email" />
                                        </div>
                                        <div class="form-group">
                                             <label for="state">State</label>
                                             <input type="text" class="form-control" id="state" placeholder="State" />
                                        </div>
                                        <div class="form-group">
                                             <label for="price">price</label>
                                             <input type="text" class="form-control" id="price" placeholder="price" />
                                        </div>
                                        <div class="form-group">
                                             <label for="new_notes">Notes</label>
                                             <input type="text" class="form-control" id="new_notes" placeholder="full Notes" />
                                        </div>
                                        <div class="form-group">
                                             <label for="new_url">Zillow url</label>
                                             <input type="text" class="form-control" id="new_url" placeholder="Zillow url" />
                                        </div>
                                        <button type="button" id="save_lead" class="btn btn-primary">
                                             Submit
                                        </button>
                                   </form>
                              </div>
                              
                              <!-- <div class="tab-pane fade show active" id="overlay_1" style='display:none' role="tabpanel" aria-labelledby="nav-call-tab">
                                   <form>
                                        <div class="form-group">
                                             <select class="form-control" id="sourceCallNumber">
                                                  <option value="" selected>Select Source Number</option>
                                             </select>
                                        </div>
                                        <div class="form-group">
                                        <input type="tel" class="form-control" id="dest_num_call" placeholder="Dest Number"  required/>
                                        </div>
                                        
                                        <div class="form-group">
                                             <input type="tel" class="form-control" id="call_1" placeholder="Your Number"  required/>
                                        </div>
                                   
                                        <button class="btn btn-primary float-right" id="make_call" type="submit"><i class="fa fa-phone-square"></i> Call</button>
                                   </form>
                              </div> -->

                              <!-- first overlay  select number -->
                              <div class="modal fade" id="overlay_1" tabindex="-1" role="dialog" aria-hidden="true">
                                   <div class="modal-dialog modal-dialog-centered" role="document">
                                        <div class="modal-content">
                                             <div class="modal-header">
                                                  <h5 class="modal-title">
                                                       select Number
                                                  </h5>
                                                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                       <span aria-hidden="true">&times;</span>
                                                  </button>
                                             </div>
                                             <div class="modal-body">
                                                  <div class="form-group" , style="margin-top: 10px;">
                                                       <div class="form-group">
                                                            <select class="form-control" id="sourceCallNumber">
                                                                 <option value="" selected>Select Source Number</option>
                                                            </select>
                                                       </div>
                                                       <div class="form-group">
                                                            <input type="tel" class="form-control" id="dest_num_call" placeholder="Dest Number"  required/>
                                                       </div>
                                                       <button class="btn btn-primary float-right" id="make_call_1" type="button"><i class="fa fa-phone-square"></i> Call</button> 
                                                  </div>
                                             </div>
                                        </div>
                                   </div> 
                              </div>










                              <!-- Add notes on number called -->
                                                  
                              <div class="modal fade" id="notesModal" tabindex="-1" role="dialog" aria-hidden="true">
                                   <div class="modal-dialog modal-dialog-centered" role="document">
                                        <div class="modal-content">
                                             <div class="modal-header">
                                                  <h5 class="modal-title">
                                                       Enter the notes for this Member
                                                  </h5>
                                                  <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                       <span aria-hidden="true">&times;</span>
                                                  </button>
                                             </div>
                                             <div class="modal-body">
                                                  <form class="px-2">
                                                       <div id="Zillow_url"></div>
                                                       <div class="form-group" , style="margin-top: 10px;">
                                                            <label for="status_val">select status</label>
                                                            <select class="form-control" id="status_val">
                                                                 <option value="-" selected="">-</option>
                                                                 <option value="Call back later">Call back later</option>
                                                                 <option value="not interested">not interested</option>
                                                            </select><br>
                                                            <label for="phone">Notes</label>
                                                            <input type="text" class="form-control" id="s_notes" placeholder="write Notes"/>
                                                       </div>
                                                       <button type="button" id="save_notes" class="btn btn-primary float-right">
                                                            save
                                                       </button>
                                                  </form>
                                             </div>
                                        </div>
                                   </div> 
                              </div>
                         </div>
                    </div>
               </div>
          </div>

          <div class="modal fade" id="activityModal" tabindex="-1" role="dialog" aria-labelledby="activityModalLabel" aria-hidden="true">
               <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                         <div class="modal-header">
                              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                   <span aria-hidden="true">&times;</span>
                              </button>
                         </div>
                         <!-- <div id="activity-body" class="modal-body text-center">
                         </div> -->
                    </div>
               </div>
          </div>

          <script>
               var passwordResetToken = getParam("token");
               var userToken = localStorage.getItem("user-token");
               
               console.log("MODE: PASSWORD_RESET, Token - " + passwordResetToken);
               
               if (userToken == null) {
                    window.location.replace("student_login.html");
               }
               function getParam(sParam) {
                    var sPageURL = window.location.search.substring(1);
                    var sURLVariables = sPageURL.split("&");
                    for (var i = 0; i < sURLVariables.length; i++) {
                         var sParameterName = sURLVariables[i].split("=");
                         if (sParameterName[0] == sParam) {
                              return sParameterName[1];
                         }
                    }
               }
               
               $(document).ready(function () {
                    $("#left_sidebar").load("sidebar.html");
                    $("#page_header").load("header.html");
               });
               $("#body-row .collapse").collapse("hide");

               function left_sidebar() {
                    SidebarCollapse();
               }
               
               function SidebarCollapse() {
                    $(".menu-collapsed").toggleClass("d-none");
                    $(".sidebar-submenu").toggleClass("d-none");
                    $(".submenu-icon").toggleClass("d-none");
                    $("#sidebar-container").toggleClass(
                         "sidebar-expanded sidebar-collapsed"
                    );

                    var SeparatorTitle = $(".sidebar-separator-title");
                    if (SeparatorTitle.hasClass("d-flex")) {
                         SeparatorTitle.removeClass("d-flex");
                    } else {
                         SeparatorTitle.addClass("d-flex");
                    }
               }
               var user_list = [];
               var selected_user_index;
               var user_leads;
               var all_numbers;

               $(document).ready(function () {
                    $.ajax({
                         url : SERVER + "voip/api_voip/getlead",
                         async : true,
                         crossDomain : true,
                         crossOrigin : true,
                         type : 'GET',
                         headers: { "Authorization": `${localStorage.getItem('user-token')}` }
                    }).done( (response)=> {
                         document.getElementById("lead_loader").remove();
                         user_leads = JSON.parse(response)
                         user_leads.forEach((item , index) => {
                              $("#lead_data").append(`<tr>
                                   <td>${item.fields.name}</td>
                                   <td>${item.fields.phone}</td>
                                   <td>${item.fields.state}</td>
                                   <td>${item.fields.status}</td>
                                   <td>${item.fields.notes}</td>
                                   <td><button onclick="call_1('${index}')" class="btn btn-primary btn-edit" type="button"><i class="fa fa-phone-square"></i></button></td>
                                   </tr>`);
                         })
                         $("#lead_table").DataTable( {
                              // initComplete: function () {
                                   // console.log("modify")
                                   // this.api().columns().every( function () {
                                   // console.log("modify_2")
                                   //      var column = this;
                                   //      console.log(column,".........................")
                                   //      var select = $('<select><option value=""></option></select>')
                                   //      console.log("modify_3")

                                   //           .appendTo( $(column.footer()).empty() )
                                   //           console.log("appended")
                                   //           .on( 'change', function () {
                                   //           var val = $.fn.dataTable.util.escapeRegex(
                                   //                $(this).val()
                                   //           );
                         
                                   //           column
                                   //                .search( val ? '^'+val+'$' : '', true, false )
                                   //                .draw();
                                   //           } );
                         
                                   //      column.data().unique().sort().each( function ( d, j ) {
                                   //           select.append( '<option value="'+d+'">'+d+'</option>' )
                                   //      } );
                                   // } );
                              // }
                         });


                         $.ajax({
                              async: true,
                              crossDomain: true,
                              crossOrigin: true,
                              url: SERVER + "voip/api_voip/getNumber",
                              type: "GET",
                              headers: { "Authorization": `${localStorage.getItem('user-token')}` }
                         }).done((numbers) => {
                              all_numbers = numbers
                         }).fail(function(err) {
                              console.log(err)
                              alert(err) 
                         })


                    }).fail((err) => {
                         console.log("errorss...",err)
                    })
               });

               $("#add_lead").click( () => {
                    $("#userLeadData").hide();
                    $("#addLead").show();
               })

               function goBack() {
                    $("#userLeadData").show();
                    $("#addLead").hide();
               }

               $('#save_lead').click( () => {           
                    name = $('#name').val()
                    phone = $('#phone').val()
                    email = $('#email').val()
                    state = $('#state').val()
                    price = $('#price').val()
                    notes = $('#new_notes').val()
                    new_url = $('#new_url').val()
                    console.log(name , phone , email , state , price , notes , new_url)
                    $.ajax({
                         url : SERVER + "voip/api_voip/getlead",
                         async : true,
                         crossOrigin : true,
                         crossDomain : true,
                         type : 'POST',
                         data : {
                              'name' : name,
                              'phone' : phone, 
                              'email' : email, 
                              'state' : state, 
                              'price' : price, 
                              'notes' : notes,
                              'new_url' : new_url,
                         },
                         headers: { "Authorization": `${localStorage.getItem('user-token')}` }
                    }).done( () => {
                         swal({	
                              title: "leads saved",
                              text: "You have successfully saved leads",	
                              icon: "success",
                              timer: 2000
                         })
                    }).fail( (err) => {
                         console.log(err);
                    })
               })

               

               function call_1(index) {
                    console.log("call_1 called...")
                    $("#overlay_1").modal();
                    $("#make_call_1").val(index)
                    $("#sourceCallNumber").click(() => {
                         if ($("#sourceCallNumber option").length === 1) {
                              all_numbers.forEach((item, i) => {
                                   $("#sourceCallNumber").append($('<option>').val(item.number).text(item.number))
                              }) 
                         }
                         var source_number = $('#sourceCallNumber').val();
                    })
               }

               // $("#make_call_1").click( () => {
               //      console.log("save notes....")
               //      var dest_num = $("#dest_num_call").val()
               //      // console.log("num",dest_num)
               //      // console.log(user_leads[index])
               //      $("#save_notes").val(user_leads[index].pk)
               //      $("#notesModal").modal();
               //      $("#Zillow_url").empty();
               //      $("#Zillow_url").append(`<h5> Zillow url </h5><a href="${user_leads[index].fields.url}">${user_leads[index].fields.url}</a> <br><br>`);
               //      $('#s_notes').val(user_leads[index].fields.notes);
               //      // $.ajax({
               //      //      url : SERVER + "voip/api_voip/leadcall",
               //      //      async : true,
               //      //      crossDomain : true,
               //      //      crossOrigin : true,
               //      //      type : 'POST',
               //      //      data : {
               //      //           "phone" : user_leads[index].fields.phone,
               //      //      },
               //      //      headers: { "Authorization": `${localStorage.getItem('user-token')}` }
               //      // }).done( ()=> {                         
               //      //     console.log("calling to lead")
               //      // })
               // })

               $("#save_notes").click( () => {
                    not_id = $("#save_notes").val();
                    status = $('#status_val').val();
                    s_note = $('#s_notes').val();
                    $.ajax({
                         url : SERVER + "voip/api_voip/getlead",
                         async : true,
                         crossDomain : true,
                         crossOrigin : true,
                         type : "PUT",
                         data : {
                              "id" : not_id,
                              "note" : s_note,
                              "status" : status,
                         },
                         headers: { "Authorization": `${localStorage.getItem('user-token')}` }
                    }).done( () => {
                         console.log("done")
                         swal({	
                              title: "notes saved",
                              text: "You have successfully saved notes",	
                              icon: "success",
                              timer: 2000
                         })
                         location.reload()
                    }).fail( (err) => {
                         console.log(err)
                    })
               })

               $(document).ready(function(){
                    $('[data-toggle="tooltip"]').tooltip();
               });
          </script>
     </body>
</html>